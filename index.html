<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>üëë BK –ö–û–†–û–ù–ê ‚Ä¢ –ú–û–ë–ò–õ–¨–ù–´–ô –ó–ê–ö–ê–ó</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f8f2e6;
            min-height: 100vh;
            padding: 10px;
        }

        /* –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò */
        .auth-screen {
            background: linear-gradient(145deg, #4a3a2a, #2d1d0c);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
        }

        .auth-card {
            background: white;
            border-radius: 50px;
            padding: 30px 20px;
            width: 100%;
            max-width: 450px;
            border: 5px solid #fec233;
            text-align: center;
        }

        .auth-card h2 {
            color: #c53a1f;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 3px solid #ba6b3c;
            border-radius: 50px;
            margin: 10px 0;
            text-align: center;
        }

        .phone-input {
            display: flex;
            align-items: center;
            border: 3px solid #ba6b3c;
            border-radius: 50px;
            margin: 10px 0;
            background: white;
        }

        .phone-prefix {
            padding: 15px;
            background: #f0dbb8;
            border-radius: 50px 0 0 50px;
            font-weight: 700;
            color: #2d1d0c;
        }

        .phone-input input {
            flex: 1;
            border: none;
            padding: 15px;
            border-radius: 0 50px 50px 0;
            font-size: 1.1rem;
            outline: none;
        }

        .auth-btn {
            background: #d49b3b;
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 50px;
            width: 100%;
            cursor: pointer;
            font-weight: 700;
            margin: 10px 0;
            box-shadow: 0 4px 0 #7e491e;
        }

        .auth-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        .main-app {
            display: none;
        }

        .header {
            background: #d62323;
            color: white;
            padding: 15px;
            border-radius: 30px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 3px solid #fec233;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .logo i {
            color: #fec233;
        }

        .user-stats {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .crowns {
            background: #fec233;
            color: #2d1d0c;
            padding: 8px 15px;
            border-radius: 40px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            cursor: pointer;
        }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .nav-item {
            flex: 1;
            background: #5c3e1f;
            color: white;
            padding: 12px;
            border-radius: 30px;
            text-align: center;
            font-weight: 700;
            border: 2px solid #fec233;
            cursor: pointer;
        }

        .nav-item.active {
            background: #fec233;
            color: #2d1d0c;
        }

        /* –ú–ï–ù–Æ */
        .menu-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2d1d0c;
            margin-bottom: 15px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .product-card {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px 8px;
            text-align: center;
            border: 2px solid #d8a76b;
            cursor: pointer;
            box-shadow: 0 4px 0 #b57c42;
            position: relative;
        }

        .product-card.crown-deal {
            border: 3px solid #fec233;
            background: #fff0d0;
        }

        .crown-price {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #9c27b0;
            color: white;
            padding: 5px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .regular-price {
            font-weight: 800;
            color: #c1411b;
        }

        .crown-deal-price {
            font-weight: 800;
            color: #9c27b0;
            text-decoration: line-through;
            font-size: 0.9rem;
        }

        /* –ö–û–†–ó–ò–ù–ê */
        .cart-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .cart-items {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin: 15px 0;
            max-height: 350px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #cbad86;
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-qty {
            background: #c1411b;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: 800;
        }

        .remove-btn {
            background: #c53a1f;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .cart-total {
            font-size: 1.8rem;
            font-weight: 800;
            color: #c53a1f;
            text-align: right;
            margin: 15px 0;
        }

        .crown-discount {
            color: #9c27b0;
            font-size: 1.1rem;
            text-align: right;
            margin-bottom: 10px;
        }

        .order-btn {
            background: #d49b3b;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 0 #7e491e;
        }

        /* –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–ö–ê–ó–ï */
        .order-info {
            background: white;
            border-radius: 30px;
            padding: 25px;
            text-align: center;
            margin-top: 20px;
            border: 4px solid #4CAF50;
            display: none;
        }

        .order-number-big {
            font-size: 4rem;
            font-weight: 900;
            color: #c53a1f;
            background: #fff2d7;
            padding: 20px;
            border-radius: 30px;
            margin: 15px 0;
        }

        .order-status {
            font-size: 1.3rem;
            padding: 15px;
            border-radius: 30px;
            margin: 15px 0;
        }

        .status-waiting { background: #ff9800; color: white; }
        .status-ready { background: #4CAF50; color: white; }
        .status-done { background: #808080; color: white; }

        /* –ò–°–¢–û–†–ò–Ø */
        .history-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .history-item {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #d8a76b;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .history-number {
            color: #c53a1f;
            font-weight: 800;
        }

        .history-crowns {
            color: #9c27b0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            z-index: 3000;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <!-- –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <i class="fas fa-crown" style="font-size: 3rem; color: #fec233; margin-bottom: 10px;"></i>
            <h2>üëë BK –ö–û–†–û–ù–ê</h2>
            <p style="margin-bottom: 20px;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è –∑–∞–∫–∞–∑–∞</p>
            
            <input type="text" id="regName" class="auth-input" placeholder="–í–∞—à–µ –∏–º—è" value="–ì–æ—Å—Ç—å">
            
            <div class="phone-input">
                <span class="phone-prefix">+7</span>
                <input type="tel" id="regPhone" placeholder="(999) 999-99-99" maxlength="10">
            </div>
            
            <button class="auth-btn" onclick="register()">
                <i class="fas fa-sign-in-alt"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
            
            <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> –ù–æ–º–µ—Ä –Ω—É–∂–µ–Ω –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–æ—Ä–æ–Ω
            </p>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="mainApp" class="main-app">
        <div class="header">
            <div class="logo">
                <i class="fas fa-crown"></i>
                <span>BK –ö–û–†–û–ù–ê</span>
            </div>
            <div class="user-stats">
                <span class="crowns" id="userCrowns">
                    <i class="fas fa-crown"></i> 0
                </span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="showPanel('menu')">üçî –ú–ï–ù–Æ</div>
            <div class="nav-item" onclick="showPanel('cart')">üõí –ö–û–†–ó–ò–ù–ê</div>
            <div class="nav-item" onclick="showPanel('history')">üìã –ò–°–¢–û–†–ò–Ø</div>
        </div>

        <!-- –ú–ï–ù–Æ -->
        <div id="menuPanel">
            <div class="menu-section">
                <div class="section-title">
                    <i class="fas fa-fire" style="color: #c53a1f;"></i> –ù–∞—à–µ –º–µ–Ω—é
                </div>
                <div class="products-grid" id="productsGrid"></div>
            </div>
        </div>

        <!-- –ö–û–†–ó–ò–ù–ê -->
        <div id="cartPanel" style="display: none;">
            <div class="cart-section">
                <div class="section-title">üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</div>
                <div class="cart-items" id="cartItems"></div>
                <div class="crown-discount" id="crownDiscount"></div>
                <div class="cart-total" id="cartTotal">0 ‚ÇΩ</div>
                <button class="order-btn" onclick="placeOrder()">
                    <i class="fas fa-check-circle"></i> –ó–ê–ö–ê–ó–ê–¢–¨
                </button>

                <div class="order-info" id="orderInfo">
                    <h3>‚úÖ –ó–ê–ö–ê–ó –û–§–û–†–ú–õ–ï–ù</h3>
                    <div class="order-number-big" id="orderNumberDisplay">1234</div>
                    <div class="order-status status-waiting" id="orderStatus">
                        ‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
                    </div>
                    <p style="color: #666; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> –°–æ–æ–±—â–∏—Ç–µ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä –∫–∞—Å—Å–∏—Ä—É
                    </p>
                </div>
            </div>
        </div>

        <!-- –ò–°–¢–û–†–ò–Ø -->
        <div id="historyPanel" style="display: none;">
            <div class="history-section">
                <div class="section-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                <div class="orders-history" id="ordersHistory"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBlZ5ZtyTXgtXxSXJAx1jOxwhTrzlHRJmo",
            authDomain: "bk-cashier.firebaseapp.com",
            databaseURL: "https://bk-cashier-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bk-cashier",
            storageBucket: "bk-cashier.firebasestorage.app",
            messagingSenderId: "385000840969",
            appId: "1:385000840969:web:1ec8d09176b6551dc0fdd8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const products = [
            { id: 1, name: '–í–æ–ø–ø–µ—Ä', price: 199, crownPrice: 50 },
            { id: 2, name: '–ß–∏–∑–±—É—Ä–≥–µ—Ä', price: 89, crownPrice: 20 },
            { id: 3, name: '–î–≤–æ–π–Ω–æ–π –í–æ–ø–ø–µ—Ä', price: 329, crownPrice: 80 },
            { id: 4, name: '–õ–æ–Ω–≥ –ß–∏–∫–µ–Ω', price: 219, crownPrice: 55 },
            { id: 5, name: '–°—Ç—Ä–∏–ø—Å—ã 3—à—Ç', price: 149, crownPrice: 35 },
            { id: 6, name: '–ù–∞–≥–≥–µ—Ç—Å—ã 6—à—Ç', price: 159, crownPrice: 40 },
            { id: 7, name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏', price: 119, crownPrice: 30 },
            { id: 8, name: '–ö–æ–ª–∞', price: 99, crownPrice: 25 },
            { id: 9, name: '–ú–æ—Ä—Å', price: 109, crownPrice: 25 },
            { id: 10, name: '–ü–∏—Ä–æ–∂–æ–∫', price: 89, crownPrice: 20 }
        ];

        let currentUser = null;
        let cart = [];
        let currentOrderNum = null;
        let userCrowns = 0;
        let userOrders = [];

        // ========== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
        window.register = () => {
            const name = document.getElementById('regName').value.trim() || '–ì–æ—Å—Ç—å';
            const phone = document.getElementById('regPhone').value.trim();
            
            if (!phone) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return;
            }

            const fullPhone = '+7' + phone;
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
            db.ref('users').orderByChild('phone').equalTo(fullPhone).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    snapshot.forEach((child) => {
                        currentUser = child.val();
                        currentUser.id = child.key;
                    });
                    showToast(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${currentUser.name}!`);
                } else {
                    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
                    currentUser = {
                        id: userId,
                        name: name,
                        phone: fullPhone,
                        crowns: 0,
                        registeredAt: Date.now()
                    };
                    db.ref('users/' + userId).set(currentUser);
                }

                enterApp();
            });
        };

        function enterApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userCrowns').innerHTML = `<i class="fas fa-crown"></i> ${currentUser.crowns || 0}`;
            
            renderProducts();
            updateCart();
            loadUserData();
            listenToUserCrowns();
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
        function loadUserData() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤
            db.ref('orders').orderByChild('userId').equalTo(currentUser.id).on('value', (snapshot) => {
                const orders = snapshot.val();
                userOrders = [];
                
                for (let num in orders) {
                    userOrders.push({
                        number: num,
                        ...orders[num]
                    });
                }
                
                userOrders.sort((a, b) => b.createdAt - a.createdAt);
                displayHistory();
            });
        }

        // ========== –°–õ–£–®–ê–¢–ï–õ–¨ –ö–û–†–û–ù ==========
        function listenToUserCrowns() {
            db.ref('users/' + currentUser.id + '/crowns').on('value', (snapshot) => {
                currentUser.crowns = snapshot.val() || 0;
                document.getElementById('userCrowns').innerHTML = `<i class="fas fa-crown"></i> ${currentUser.crowns}`;
            });
        }

        // ========== –í–´–•–û–î ==========
        window.logout = () => {
            currentUser = null;
            cart = [];
            userOrders = [];
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('regName').value = '–ì–æ—Å—Ç—å';
            document.getElementById('regPhone').value = '';
        };

        // ========== –†–ï–ù–î–ï–† –¢–û–í–ê–†–û–í ==========
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            products.forEach(p => {
                const canUseCrowns = currentUser.crowns >= p.crownPrice;
                const card = document.createElement('div');
                card.className = `product-card ${canUseCrowns ? 'crown-deal' : ''}`;
                
                if (canUseCrowns) {
                    card.innerHTML = `
                        <div class="crown-price"><i class="fas fa-crown"></i> ${p.crownPrice}</div>
                        <div class="product-name">${p.name}</div>
                        <div class="crown-deal-price">${p.price} ‚ÇΩ</div>
                        <div class="regular-price">1 ‚ÇΩ</div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="product-name">${p.name}</div>
                        <div class="regular-price">${p.price} ‚ÇΩ</div>
                    `;
                }
                
                card.onclick = () => addToCart(p, canUseCrowns);
                grid.appendChild(card);
            });
        }

        // ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ö–û–†–ó–ò–ù–£ ==========
        function addToCart(product, useCrowns = false) {
            const existing = cart.find(i => i.id === product.id);
            
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ 
                    ...product, 
                    quantity: 1,
                    useCrowns: useCrowns,
                    finalPrice: useCrowns ? 1 : product.price
                });
            }
            
            updateCart();
            showToast('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
        }

        // ========== –£–î–ê–õ–ï–ù–ò–ï –ò–ó –ö–û–†–ó–ò–ù–´ ==========
        function removeFromCart(id) {
            const index = cart.findIndex(i => i.id === id);
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–†–ó–ò–ù–´ ==========
        function updateCart() {
            const container = document.getElementById('cartItems');
            const totalSpan = document.getElementById('cartTotal');
            const discountDiv = document.getElementById('crownDiscount');

            if (cart.length === 0) {
                container.innerHTML = '<div class="empty-state">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
                totalSpan.innerText = '0 ‚ÇΩ';
                discountDiv.innerHTML = '';
                return;
            }

            let html = '';
            let total = 0;
            let crownSaved = 0;
            
            cart.forEach(item => {
                const price = item.useCrowns ? 1 : item.price;
                total += price * item.quantity;
                if (item.useCrowns) {
                    crownSaved += (item.price - 1) * item.quantity;
                }
                
                html += `
                    <div class="cart-item">
                        <div class="item-info">
                            <span class="item-qty">${item.quantity}</span>
                            <span>${item.name}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${price * item.quantity} ‚ÇΩ</span>
                            <button class="remove-btn" onclick="removeFromCart(${item.id})">‚àí</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            totalSpan.innerText = total + ' ‚ÇΩ';
            
            if (crownSaved > 0) {
                discountDiv.innerHTML = `üëë –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ: ${crownSaved} ‚ÇΩ`;
            } else {
                discountDiv.innerHTML = '';
            }
        }

        // ========== –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ==========
        function placeOrder() {
            if (cart.length === 0) {
                showToast('‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }

            const orderNum = Math.floor(1000 + Math.random() * 9000);
            const total = cart.reduce((acc, i) => acc + (i.useCrowns ? 1 : i.price) * i.quantity, 0);
            const crownSpent = cart.reduce((acc, i) => acc + (i.useCrowns ? i.crownPrice * i.quantity : 0), 0);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ –∫–æ—Ä–æ–Ω
            if (crownSpent > currentUser.crowns) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ—Ä–æ–Ω');
                return;
            }

            const orderData = {
                userId: currentUser.id,
                userName: currentUser.name,
                userPhone: currentUser.phone,
                items: cart.map(i => ({ 
                    name: i.name, 
                    price: i.useCrowns ? 1 : i.price, 
                    originalPrice: i.price,
                    quantity: i.quantity,
                    usedCrowns: i.useCrowns ? i.crownPrice : 0
                })),
                total: total,
                crownSpent: crownSpent,
                crownEarned: Math.floor(total / 100),
                status: 'waiting',
                createdAt: Date.now()
            };

            db.ref('orders/' + orderNum).set(orderData).then(() => {
                // –°–ø–∏—Å—ã–≤–∞–µ–º –∫–æ—Ä–æ–Ω—ã
                db.ref('users/' + currentUser.id + '/crowns').set(currentUser.crowns - crownSpent);
                
                currentOrderNum = orderNum;
                document.getElementById('orderInfo').style.display = 'block';
                document.getElementById('orderNumberDisplay').innerText = orderNum;
                
                listenToOrder(orderNum);
                
                cart = [];
                updateCart();
                
                showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
                showPanel('history');
            });
        }

        // ========== –°–õ–£–®–ê–¢–ï–õ–¨ –°–¢–ê–¢–£–°–ê ==========
        function listenToOrder(orderNum) {
            db.ref('orders/' + orderNum).on('value', (snapshot) => {
                const order = snapshot.val();
                if (order) {
                    const statusDiv = document.getElementById('orderStatus');
                    
                    if (order.status === 'ready') {
                        statusDiv.innerHTML = '‚úÖ –ó–ê–ö–ê–ó –ì–û–¢–û–í!';
                        statusDiv.className = 'order-status status-ready';
                        showToast('‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤!');
                        if (navigator.vibrate) navigator.vibrate(200);
                    } else if (order.status === 'done') {
                        statusDiv.innerHTML = 'üõí –ó–ê–ö–ê–ó –í–´–î–ê–ù';
                        statusDiv.className = 'order-status status-done';
                        
                        // –ù–∞—á–∏—Å–ª—è–µ–º –∫–æ—Ä–æ–Ω—ã –∑–∞ –∑–∞–∫–∞–∑
                        const newCrowns = (currentUser.crowns || 0) + order.crownEarned;
                        db.ref('users/' + currentUser.id + '/crowns').set(newCrowns);
                    }
                    
                    loadUserData();
                }
            });
        }

        // ========== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–°–¢–û–†–ò–ò ==========
        function displayHistory() {
            const historyDiv = document.getElementById('ordersHistory');
            
            if (userOrders.length === 0) {
                historyDiv.innerHTML = '<div class="empty-state">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                return;
            }

            let html = '';
            userOrders.forEach(order => {
                let statusText = '';
                let statusClass = '';
                
                if (order.status === 'waiting') {
                    statusText = '‚è≥ –ì–æ—Ç–æ–≤–∏—Ç—Å—è';
                    statusClass = 'status-waiting';
                } else if (order.status === 'ready') {
                    statusText = '‚úÖ –ì–æ—Ç–æ–≤';
                    statusClass = 'status-ready';
                } else {
                    statusText = 'üõí –í—ã–¥–∞–Ω';
                    statusClass = 'status-done';
                }

                const date = new Date(order.createdAt).toLocaleString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit'
                });

                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-number">–ó–∞–∫–∞–∑ #${order.number}</span>
                            <span class="history-crowns"><i class="fas fa-crown"></i> +${order.crownEarned || 0}</span>
                        </div>
                        <div>${order.items.map(i => `${i.name} x${i.quantity}`).join(' ‚Ä¢ ')}</div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span>–°—É–º–º–∞: ${order.total} ‚ÇΩ</span>
                            <span class="${statusClass}">${statusText}</span>
                        </div>
                        <div style="color: #666; font-size: 0.8rem; margin-top: 5px;">${date}</div>
                    </div>
                `;
            });
            
            historyDiv.innerHTML = html;
        }

        // ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========
        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerHTML = text;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
        }

        // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–ê–ù–ï–õ–ï–ô ==========
        window.showPanel = (panel) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('menuPanel').style.display = 'none';
            document.getElementById('cartPanel').style.display = 'none';
            document.getElementById('historyPanel').style.display = 'none';

            if (panel === 'menu') {
                document.getElementById('menuPanel').style.display = 'block';
            } else if (panel === 'cart') {
                document.getElementById('cartPanel').style.display = 'block';
            } else {
                document.getElementById('historyPanel').style.display = 'block';
                loadUserData();
            }
        };

        // ========== –ü–†–û–í–ï–†–ö–ê –°–û–•–†–ê–ù–Å–ù–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
    </script>
</body>
</html>
