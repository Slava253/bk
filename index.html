<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>üëë WHOPPER BAR ‚Ä¢ –ú–û–ë–ò–õ–¨–ù–´–ô –ó–ê–ö–ê–ó</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f8f2e6;
            min-height: 100vh;
            padding: 12px;
        }

        .auth-screen {
            background: linear-gradient(145deg, #4a3a2a, #2d1d0c);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
        }

        .auth-card {
            background: white;
            border-radius: 50px;
            padding: 40px 30px;
            width: 100%;
            max-width: 450px;
            border: 5px solid #fec233;
            text-align: center;
        }

        .auth-card h1 {
            color: #d62323;
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .auth-card h2 {
            color: #c53a1f;
            font-size: 1.5rem;
            margin-bottom: 25px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 3px solid #ba6b3c;
            border-radius: 60px;
            margin: 10px 0;
            text-align: center;
        }

        .phone-input {
            display: flex;
            align-items: center;
            border: 3px solid #ba6b3c;
            border-radius: 60px;
            margin: 10px 0;
            background: white;
        }

        .phone-prefix {
            padding: 15px;
            background: #d49b3b;
            border-radius: 60px 0 0 60px;
            font-weight: 700;
            color: white;
        }

        .phone-input input {
            flex: 1;
            border: none;
            padding: 15px;
            border-radius: 0 60px 60px 0;
            font-size: 1.1rem;
            outline: none;
        }

        .auth-btn {
            background: #d49b3b;
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 60px;
            width: 100%;
            cursor: pointer;
            font-weight: 700;
            margin: 10px 0;
            box-shadow: 0 4px 0 #7e491e;
        }

        .auth-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .main-app {
            display: none;
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: #d62323;
            color: white;
            padding: 15px;
            border-radius: 30px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 3px solid #fec233;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crowns {
            background: #fec233;
            color: #2d1d0c;
            padding: 8px 15px;
            border-radius: 40px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 5px 12px;
            border-radius: 30px;
            cursor: pointer;
        }

        .nav {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .nav-item {
            flex: 1;
            background: #5c3e1f;
            color: white;
            padding: 12px;
            border-radius: 30px;
            text-align: center;
            font-weight: 700;
            border: 2px solid #fec233;
            cursor: pointer;
            min-width: 100px;
        }

        .nav-item.active {
            background: #fec233;
            color: #2d1d0c;
        }

        .profile-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
            margin-bottom: 15px;
        }

        .profile-field {
            margin-bottom: 15px;
        }

        .profile-label {
            font-weight: 700;
            color: #2d1d0c;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d8a76b;
            border-radius: 30px;
            font-size: 1rem;
        }

        .address-card {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #d8a76b;
        }

        .address-text {
            margin-bottom: 10px;
            color: #2d1d0c;
        }

        .address-actions {
            display: flex;
            gap: 10px;
        }

        .address-btn {
            flex: 1;
            background: #d49b3b;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 30px;
            cursor: pointer;
        }

        .order-type {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .type-btn {
            flex: 1;
            background: #fff2d7;
            border: 3px solid #d8a76b;
            padding: 15px;
            border-radius: 30px;
            text-align: center;
            cursor: pointer;
        }

        .type-btn.active {
            background: #fec233;
            border-color: #c53a1f;
        }

        .menu-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: #2d1d0c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            padding: 15px 8px;
            text-align: center;
            border: 2px solid #d8a76b;
            cursor: pointer;
            box-shadow: 0 4px 0 #b57c42;
            position: relative;
        }

        .product-card:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .product-card.crown-deal {
            border: 3px solid #9c27b0;
            background: #f3e5f5;
        }

        .product-name {
            font-weight: 700;
            margin-bottom: 5px;
        }

        .product-price {
            font-weight: 800;
            color: #c1411b;
        }

        .crown-price {
            position: absolute;
            top: -8px;
            right: -5px;
            background: #9c27b0;
            color: white;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .cart-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .cart-items {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin: 15px 0;
            max-height: 350px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #cbad86;
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-qty {
            background: #c1411b;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: 800;
        }

        .item-controls {
            display: flex;
            gap: 5px;
        }

        .item-btn {
            background: #c53a1f;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 700;
        }

        .item-btn.minus {
            background: #ff9800;
        }

        .cart-summary {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin: 15px 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .cart-total {
            font-size: 1.8rem;
            font-weight: 800;
            color: #c53a1f;
            text-align: right;
            margin: 15px 0;
        }

        .order-btn {
            background: #d49b3b;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 30px;
            font-size: 1.3rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 0 #7e491e;
        }

        .order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .order-info {
            background: white;
            border-radius: 30px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            border: 4px solid #4CAF50;
            display: none;
        }

        .order-number-big {
            font-size: 4rem;
            font-weight: 900;
            color: #c53a1f;
            background: #fff2d7;
            padding: 15px;
            border-radius: 30px;
            margin: 15px 0;
        }

        .order-status {
            font-size: 1.2rem;
            padding: 12px;
            border-radius: 30px;
            margin: 10px 0;
        }

        .status-waiting { background: #ff9800; color: white; }
        .status-ready { background: #4CAF50; color: white; }
        .status-courier { background: #2196F3; color: white; }
        .status-done { background: #808080; color: white; }

        .history-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .history-item {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #d8a76b;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 60px;
            font-weight: 600;
            z-index: 3000;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <h1>WHOPPER BAR</h1>
            <h2>üëë –ö–û–†–û–ù–ê</h2>
            <p style="margin-bottom: 20px;">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –≤—Ö–æ–¥–∞</p>
            
            <div class="phone-input">
                <span class="phone-prefix">+7</span>
                <input type="tel" id="phoneInput" placeholder="(999) 999-99-99" maxlength="10">
            </div>
            
            <button class="auth-btn" onclick="loginWithPhone()">
                <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
            </button>
            
            <button class="auth-btn" style="background: #4CAF50;" onclick="loginAsGuest()">
                <i class="fas fa-user"></i> –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å
            </button>
        </div>
    </div>

    <div id="mainApp" class="main-app">
        <div class="header">
            <div class="logo">
                <i class="fas fa-crown"></i>
                <span>WHOPPER BAR</span>
            </div>
            <div class="user-info">
                <span class="crowns" id="userCrowns">
                    <i class="fas fa-crown"></i> 0
                </span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="showPanel('menu')">üçî –ú–ï–ù–Æ</div>
            <div class="nav-item" onclick="showPanel('crown')">üëë –ó–ê 1‚ÇΩ</div>
            <div class="nav-item" onclick="showPanel('cart')">üõí –ö–û–†–ó–ò–ù–ê</div>
            <div class="nav-item" onclick="showPanel('profile')">üë§ –ü–†–û–§–ò–õ–¨</div>
            <div class="nav-item" onclick="showPanel('history')">üìã –ò–°–¢–û–†–ò–Ø</div>
        </div>

        <div id="profilePanel" style="display: none;">
            <div class="profile-section">
                <div class="section-title">
                    <i class="fas fa-user"></i>
                    <span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                </div>
                
                <div class="profile-field">
                    <div class="profile-label"><i class="fas fa-user"></i> –ò–º—è</div>
                    <input type="text" id="profileName" class="profile-input" placeholder="–í–∞—à–µ –∏–º—è">
                </div>

                <div class="profile-field">
                    <div class="profile-label"><i class="fas fa-phone"></i> –¢–µ–ª–µ—Ñ–æ–Ω</div>
                    <input type="text" id="profilePhone" class="profile-input" readonly>
                </div>

                <div class="profile-field">
                    <div class="profile-label"><i class="fas fa-crown"></i> –ú–æ–∏ –∫–æ—Ä–æ–Ω—ã</div>
                    <div class="crowns" id="profileCrowns">0</div>
                </div>

                <div class="section-title" style="margin-top: 20px;">
                    <i class="fas fa-home"></i>
                    <span>–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                </div>

                <div id="addressesList"></div>

                <button class="auth-btn" style="margin-top: 10px;" onclick="addNewAddress()">
                    <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å
                </button>
            </div>
        </div>

        <div id="menuPanel">
            <div class="menu-section">
                <div class="section-title">
                    <i class="fas fa-fire"></i>
                    <span>–ù–∞—à–µ –º–µ–Ω—é</span>
                </div>
                <div class="products-grid" id="regularProducts"></div>
            </div>
        </div>

        <div id="crownPanel" style="display: none;">
            <div class="menu-section">
                <div class="section-title">
                    <i class="fas fa-crown" style="color: #9c27b0;"></i>
                    <span>–ë–ª—é–¥–∞ –∑–∞ 1 —Ä—É–±–ª—å</span>
                </div>
                <div class="crowns" style="margin-bottom: 15px;">
                    <i class="fas fa-crown"></i> –£ –≤–∞—Å: <span id="crownsForDeals">0</span>
                </div>
                <div class="products-grid" id="crownProducts"></div>
            </div>
        </div>

        <div id="cartPanel" style="display: none;">
            <div class="cart-section">
                <div class="order-type">
                    <div class="type-btn active" onclick="setOrderType('restaurant')">
                        <i class="fas fa-store"></i> –í —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
                    </div>
                    <div class="type-btn" onclick="setOrderType('delivery')">
                        <i class="fas fa-truck"></i> –î–æ—Å—Ç–∞–≤–∫–∞
                    </div>
                </div>

                <div id="deliveryAddress" style="display: none;">
                    <select id="addressSelect" class="profile-input">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</option>
                    </select>
                </div>

                <div class="cart-items" id="cartItems">
                    <div style="text-align:center; padding:20px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
                </div>

                <div class="cart-summary" id="cartSummary">
                    <div class="summary-row">
                        <span>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</span>
                        <span id="subtotal">0 ‚ÇΩ</span>
                    </div>
                    <div class="summary-row" id="crownsRow" style="display: none;">
                        <span>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∫–æ—Ä–æ–Ω:</span>
                        <span id="crownsSpent">0</span>
                    </div>
                    <div class="summary-row" id="deliveryRow" style="display: none;">
                        <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                        <span>99 ‚ÇΩ</span>
                    </div>
                </div>

                <div class="cart-total" id="cartTotal">0 ‚ÇΩ</div>
                
                <button class="order-btn" onclick="placeOrder()" id="orderBtn">
                    <i class="fas fa-check-circle"></i> –ó–ê–ö–ê–ó–ê–¢–¨
                </button>

                <div class="order-info" id="orderInfo">
                    <h3>‚úÖ –ó–ê–ö–ê–ó –û–§–û–†–ú–õ–ï–ù</h3>
                    <div class="order-number-big" id="orderNumberDisplay">1234</div>
                    <div class="order-status status-waiting" id="orderStatus">
                        ‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
                    </div>
                </div>
            </div>
        </div>

        <div id="historyPanel" style="display: none;">
            <div class="history-section">
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    <span>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</span>
                </div>
                <div class="orders-history" id="ordersHistory"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBlZ5ZtyTXgtXxSXJAx1jOxwhTrzlHRJmo",
            authDomain: "bk-cashier.firebaseapp.com",
            databaseURL: "https://bk-cashier-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bk-cashier",
            storageBucket: "bk-cashier.firebasestorage.app",
            messagingSenderId: "385000840969",
            appId: "1:385000840969:web:1ec8d09176b6551dc0fdd8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // –û–±—ã—á–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
        const regularProducts = [
            { id: 1, name: '–í–æ–ø–ø–µ—Ä', price: 199 },
            { id: 2, name: '–ß–∏–∑–±—É—Ä–≥–µ—Ä', price: 89 },
            { id: 3, name: '–î–≤–æ–π–Ω–æ–π –í–æ–ø–ø–µ—Ä', price: 329 },
            { id: 4, name: '–õ–æ–Ω–≥ –ß–∏–∫–µ–Ω', price: 219 },
            { id: 5, name: '–°—Ç—Ä–∏–ø—Å—ã 3—à—Ç', price: 149 },
            { id: 6, name: '–ù–∞–≥–≥–µ—Ç—Å—ã 6—à—Ç', price: 159 },
            { id: 7, name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏', price: 119 },
            { id: 8, name: '–ö–æ–ª–∞', price: 99 },
            { id: 9, name: '–ú–æ—Ä—Å', price: 109 },
            { id: 10, name: '–ü–∏—Ä–æ–∂–æ–∫', price: 89 }
        ];

        // –¢–æ–≤–∞—Ä—ã –∑–∞ 1 —Ä—É–±–ª—å
        const crownProducts = [
            { id: 101, name: '–í–æ–ø–ø–µ—Ä (1‚ÇΩ)', price: 1, crownCost: 10 },
            { id: 102, name: '–ß–∏–∑–±—É—Ä–≥–µ—Ä (1‚ÇΩ)', price: 1, crownCost: 4 },
            { id: 103, name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏ (1‚ÇΩ)', price: 1, crownCost: 6 },
            { id: 104, name: '–ö–æ–ª–∞ (1‚ÇΩ)', price: 1, crownCost: 5 },
            { id: 105, name: '–ü–∏—Ä–æ–∂–æ–∫ (1‚ÇΩ)', price: 1, crownCost: 4 },
            { id: 106, name: '–ù–∞–≥–≥–µ—Ç—Å—ã 3—à—Ç (1‚ÇΩ)', price: 1, crownCost: 8 },
            { id: 107, name: '–ú–æ—Ä–æ–∂–µ–Ω–æ–µ (1‚ÇΩ)', price: 1, crownCost: 3 }
        ];

        let currentUser = null;
        let cart = [];
        let userCrowns = 0;
        let userOrders = [];
        let orderType = 'restaurant';
        let selectedAddress = null;

        (function checkSavedUser() {
            const saved = localStorage.getItem('whopperUser');
            if (saved) {
                try {
                    const userData = JSON.parse(saved);
                    if (userData.phone) {
                        loginWithPhone(userData.phone, true);
                    }
                } catch (e) {
                    console.log('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            }
        })();

        window.loginWithPhone = (savedPhone, isAuto = false) => {
            let phone;
            if (isAuto) {
                phone = savedPhone;
            } else {
                phone = document.getElementById('phoneInput').value.trim();
                if (!phone || phone.length < 10) {
                    showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é');
                    return;
                }
                phone = '+7' + phone;
            }

            db.ref('users').orderByChild('phone').equalTo(phone).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        currentUser = child.val();
                        currentUser.id = child.key;
                        userCrowns = currentUser.crowns || 0;
                    });
                    showToast(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${currentUser.name || '–ì–æ—Å—Ç—å'}!`);
                } else {
                    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    currentUser = {
                        id: userId,
                        phone: phone,
                        name: '–ì–æ—Å—Ç—å',
                        crowns: 0,
                        addresses: [],
                        registeredAt: Date.now()
                    };
                    db.ref('users/' + userId).set(currentUser);
                    userCrowns = 0;
                    showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
                }

                localStorage.setItem('whopperUser', JSON.stringify({
                    phone: phone,
                    name: currentUser.name
                }));

                enterApp();
            });
        };

        window.loginAsGuest = () => {
            const guestId = 'guest_' + Date.now();
            currentUser = {
                id: guestId,
                name: '–ì–æ—Å—Ç—å',
                isGuest: true,
                crowns: 0,
                addresses: []
            };
            
            localStorage.removeItem('whopperUser');
            showToast('–í—Ö–æ–¥ –∫–∞–∫ –≥–æ—Å—Ç—å');
            enterApp();
        };

        function enterApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            updateCrownsDisplay();
            
            renderRegularProducts();
            renderCrownProducts();
            updateCart();
            loadUserOrders();
            listenToUserCrowns();
            loadProfile();
        }

        window.logout = () => {
            currentUser = null;
            cart = [];
            userOrders = [];
            localStorage.removeItem('whopperUser');
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('phoneInput').value = '';
        };

        function updateCrownsDisplay() {
            document.getElementById('userCrowns').innerHTML = `<i class="fas fa-crown"></i> ${userCrowns}`;
            document.getElementById('profileCrowns').innerHTML = `<i class="fas fa-crown"></i> ${userCrowns}`;
            document.getElementById('crownsForDeals').innerText = userCrowns;
        }

        function loadProfile() {
            if (!currentUser || currentUser.isGuest) return;
            
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            
            document.getElementById('profileName').onchange = function() {
                currentUser.name = this.value;
                db.ref('users/' + currentUser.id + '/name').set(this.value);
                localStorage.setItem('whopperUser', JSON.stringify({
                    phone: currentUser.phone,
                    name: currentUser.name
                }));
            };

            const addressesList = document.getElementById('addressesList');
            const addressSelect = document.getElementById('addressSelect');
            
            if (currentUser.addresses && currentUser.addresses.length > 0) {
                let html = '';
                addressSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</option>';
                
                currentUser.addresses.forEach((addr, index) => {
                    html += `
                        <div class="address-card">
                            <div class="address-text">${addr}</div>
                            <div class="address-actions">
                                <button class="address-btn" onclick="selectAddress('${addr}')">–í—ã–±—Ä–∞—Ç—å</button>
                                <button class="address-btn" style="background:#c53a1f;" onclick="deleteAddress(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                    addressSelect.innerHTML += `<option value="${addr}">${addr}</option>`;
                });
                addressesList.innerHTML = html;
            } else {
                addressesList.innerHTML = '<p style="color:#666;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</p>';
            }
        }

        window.addNewAddress = () => {
            const address = prompt('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:');
            if (address && address.trim()) {
                if (!currentUser.addresses) currentUser.addresses = [];
                currentUser.addresses.push(address.trim());
                db.ref('users/' + currentUser.id + '/addresses').set(currentUser.addresses);
                loadProfile();
                showToast('‚úÖ –ê–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω');
            }
        };

        window.selectAddress = (address) => {
            selectedAddress = address;
            document.getElementById('addressSelect').value = address;
            showToast(`–í—ã–±—Ä–∞–Ω –∞–¥—Ä–µ—Å: ${address}`);
        };

        window.deleteAddress = (index) => {
            currentUser.addresses.splice(index, 1);
            db.ref('users/' + currentUser.id + '/addresses').set(currentUser.addresses);
            loadProfile();
            showToast('üóëÔ∏è –ê–¥—Ä–µ—Å —É–¥–∞–ª—ë–Ω');
        };

        window.setOrderType = (type) => {
            orderType = type;
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const deliveryDiv = document.getElementById('deliveryAddress');
            const deliveryRow = document.getElementById('deliveryRow');
            
            if (type === 'delivery') {
                deliveryDiv.style.display = 'block';
                deliveryRow.style.display = 'flex';
            } else {
                deliveryDiv.style.display = 'none';
                deliveryRow.style.display = 'none';
            }
            
            updateCart();
        };

        function renderRegularProducts() {
            const grid = document.getElementById('regularProducts');
            grid.innerHTML = '';
            
            regularProducts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${p.price} ‚ÇΩ</div>
                `;
                card.onclick = () => addToCart(p, false);
                grid.appendChild(card);
            });
        }

        function renderCrownProducts() {
            const grid = document.getElementById('crownProducts');
            grid.innerHTML = '';
            
            crownProducts.forEach(p => {
                const canBuy = !currentUser?.isGuest && userCrowns >= p.crownCost;
                const card = document.createElement('div');
                card.className = `product-card ${canBuy ? 'crown-deal' : ''}`;
                
                card.innerHTML = `
                    <div class="crown-price"><i class="fas fa-crown"></i> ${p.crownCost}</div>
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${p.price} ‚ÇΩ</div>
                `;
                
                if (canBuy) {
                    card.onclick = () => addToCart(p, true, p.crownCost);
                } else {
                    card.style.opacity = '0.5';
                    card.title = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ—Ä–æ–Ω';
                }
                
                grid.appendChild(card);
            });
        }

        function addToCart(product, useCrowns = false, crownCost = 0) {
            const existing = cart.find(i => i.id === product.id && i.useCrowns === useCrowns);
            
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ 
                    ...product, 
                    quantity: 1,
                    useCrowns: useCrowns,
                    crownCost: crownCost,
                    finalPrice: useCrowns ? 1 : product.price
                });
            }
            
            updateCart();
            showToast('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
        }

        function removeOneFromCart(id, useCrowns) {
            const index = cart.findIndex(i => i.id === id && i.useCrowns === useCrowns);
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        }

        function removeAllFromCart(id, useCrowns) {
            cart = cart.filter(i => !(i.id === id && i.useCrowns === useCrowns));
            updateCart();
        }

        function updateCart() {
            const container = document.getElementById('cartItems');
            const subtotalSpan = document.getElementById('subtotal');
            const crownsRow = document.getElementById('crownsRow');
            const crownsSpentSpan = document.getElementById('crownsSpent');
            const totalSpan = document.getElementById('cartTotal');

            if (cart.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
                subtotalSpan.innerText = '0 ‚ÇΩ';
                crownsRow.style.display = 'none';
                totalSpan.innerText = '0 ‚ÇΩ';
                return;
            }

            let html = '';
            let subtotal = 0;
            let totalCrownsSpent = 0;
            
            cart.forEach(item => {
                const itemTotal = item.finalPrice * item.quantity;
                subtotal += itemTotal;
                if (item.useCrowns) totalCrownsSpent += item.crownCost * item.quantity;
                
                html += `
                    <div class="cart-item">
                        <div class="item-info">
                            <span class="item-qty">${item.quantity}</span>
                            <span>${item.name}</span>
                            ${item.useCrowns ? '<span style="color:#9c27b0;"><i class="fas fa-crown"></i></span>' : ''}
                        </div>
                        <div class="item-controls">
                            <span>${itemTotal} ‚ÇΩ</span>
                            <button class="item-btn minus" onclick="removeOneFromCart(${item.id}, ${item.useCrowns})">‚àí</button>
                            <button class="item-btn" onclick="removeAllFromCart(${item.id}, ${item.useCrowns})">‚úï</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            subtotalSpan.innerText = subtotal + ' ‚ÇΩ';
            
            if (totalCrownsSpent > 0) {
                crownsRow.style.display = 'flex';
                crownsSpentSpan.innerText = totalCrownsSpent;
            } else {
                crownsRow.style.display = 'none';
            }
            
            let total = subtotal;
            if (orderType === 'delivery') total += 99;
            
            totalSpan.innerText = total + ' ‚ÇΩ';
        }

        function placeOrder() {
            if (cart.length === 0) {
                showToast('‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }

            if (orderType === 'delivery') {
                const addressSelect = document.getElementById('addressSelect');
                if (!addressSelect.value) {
                    showToast('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏');
                    return;
                }
                selectedAddress = addressSelect.value;
            }

            const totalCrownsSpent = cart.reduce((acc, i) => acc + (i.useCrowns ? i.crownCost * i.quantity : 0), 0);
            
            if (!currentUser.isGuest && totalCrownsSpent > userCrowns) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ—Ä–æ–Ω');
                return;
            }

            const orderNum = Math.floor(1000 + Math.random() * 9000);
            const subtotal = cart.reduce((acc, i) => acc + i.finalPrice * i.quantity, 0);
            const delivery = orderType === 'delivery' ? 99 : 0;
            const total = subtotal + delivery;
            const crownEarned = Math.floor(total / 100);

            const orderData = {
                userId: currentUser.id,
                userName: currentUser.name || '–ì–æ—Å—Ç—å',
                items: cart.map(i => ({
                    name: i.name,
                    price: i.finalPrice,
                    originalPrice: i.price,
                    quantity: i.quantity,
                    crownCost: i.crownCost || 0,
                    useCrowns: i.useCrowns || false
                })),
                subtotal: subtotal,
                delivery: delivery,
                total: total,
                crownsSpent: totalCrownsSpent,
                crownsEarned: crownEarned,
                orderType: orderType,
                address: orderType === 'delivery' ? selectedAddress : null,
                status: 'waiting',
                createdAt: Date.now()
            };

            db.ref('orders/' + orderNum).set(orderData).then(() => {
                if (!currentUser.isGuest && totalCrownsSpent > 0) {
                    const newCrowns = userCrowns - totalCrownsSpent;
                    db.ref('users/' + currentUser.id + '/crowns').set(newCrowns);
                }
                
                document.getElementById('orderInfo').style.display = 'block';
                document.getElementById('orderNumberDisplay').innerText = orderNum;
                document.getElementById('orderBtn').style.display = 'none';
                
                listenToOrder(orderNum);
                
                cart = [];
                updateCart();
                showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
            });
        }

        function listenToOrder(orderNum) {
            db.ref('orders/' + orderNum).on('value', (snapshot) => {
                const order = snapshot.val();
                if (order) {
                    const statusDiv = document.getElementById('orderStatus');
                    
                    if (order.status === 'ready') {
                        statusDiv.innerHTML = '‚úÖ –ó–ê–ö–ê–ó –ì–û–¢–û–í!';
                        statusDiv.className = 'order-status status-ready';
                        showToast('‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤!');
                        if (navigator.vibrate) navigator.vibrate(200);
                    } else if (order.status === 'courier') {
                        statusDiv.innerHTML = 'üöö –ó–ê–ö–ê–ó –ü–ï–†–ï–î–ê–ù –ö–£–†–¨–ï–†–£';
                        statusDiv.className = 'order-status status-courier';
                        showToast('üöö –ó–∞–∫–∞–∑ –ø–µ—Ä–µ–¥–∞–Ω –∫—É—Ä—å–µ—Ä—É');
                    } else if (order.status === 'done') {
                        statusDiv.innerHTML = order.orderType === 'delivery' ? '‚úÖ –ó–ê–ö–ê–ó –î–û–°–¢–ê–í–õ–ï–ù' : 'üõí –ó–ê–ö–ê–ó –í–´–î–ê–ù';
                        statusDiv.className = 'order-status status-done';
                        
                        if (!currentUser.isGuest && order.crownsEarned) {
                            const newCrowns = userCrowns + order.crownsEarned;
                            db.ref('users/' + currentUser.id + '/crowns').set(newCrowns);
                        }
                    }
                }
            });
        }

        function loadUserOrders() {
            if (!currentUser || currentUser.isGuest) return;
            
            db.ref('orders').orderByChild('userId').equalTo(currentUser.id).on('value', (snapshot) => {
                const orders = snapshot.val();
                userOrders = [];
                
                for (let num in orders) {
                    userOrders.push({
                        number: num,
                        ...orders[num]
                    });
                }
                
                userOrders.sort((a, b) => b.createdAt - a.createdAt);
                displayHistory();
            });
        }

        function listenToUserCrowns() {
            if (!currentUser || currentUser.isGuest) return;
            
            db.ref('users/' + currentUser.id + '/crowns').on('value', (snapshot) => {
                userCrowns = snapshot.val() || 0;
                updateCrownsDisplay();
                renderCrownProducts();
            });
        }

        function displayHistory() {
            const historyDiv = document.getElementById('ordersHistory');
            
            if (userOrders.length === 0) {
                historyDiv.innerHTML = '<div style="text-align:center; padding:20px;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                return;
            }

            let html = '';
            userOrders.forEach(order => {
                let statusText = '';
                let statusEmoji = '';
                
                if (order.status === 'waiting') {
                    statusText = '–ì–æ—Ç–æ–≤–∏—Ç—Å—è';
                    statusEmoji = '‚è≥';
                } else if (order.status === 'ready') {
                    statusText = '–ì–æ—Ç–æ–≤';
                    statusEmoji = '‚úÖ';
                } else if (order.status === 'courier') {
                    statusText = '–£ –∫—É—Ä—å–µ—Ä–∞';
                    statusEmoji = 'üöö';
                } else {
                    statusText = order.orderType === 'delivery' ? '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' : '–í—ã–¥–∞–Ω';
                    statusEmoji = '‚úÖ';
                }

                const typeIcon = order.orderType === 'delivery' ? 'üöö' : 'üè™';
                const typeText = order.orderType === 'delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞' : '–í —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ';

                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-number">–ó–∞–∫–∞–∑ #${order.number}</span>
                            <span><i class="fas fa-crown"></i> +${order.crownsEarned || 0}</span>
                        </div>
                        <div>${order.items.map(i => `${i.name} x${i.quantity}`).join(' ‚Ä¢ ')}</div>
                        <div style="margin-top:5px;">
                            ${typeIcon} ${typeText} ‚Ä¢ –°—É–º–º–∞: ${order.total} ‚ÇΩ ‚Ä¢ ${statusEmoji} ${statusText}
                        </div>
                    </div>
                `;
            });
            
            historyDiv.innerHTML = html;
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerHTML = text;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
        }

        window.showPanel = (panel) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('menuPanel').style.display = 'none';
            document.getElementById('crownPanel').style.display = 'none';
            document.getElementById('cartPanel').style.display = 'none';
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('historyPanel').style.display = 'none';

            if (panel === 'menu') {
                document.getElementById('menuPanel').style.display = 'block';
            } else if (panel === 'crown') {
                document.getElementById('crownPanel').style.display = 'block';
            } else if (panel === 'cart') {
                document.getElementById('cartPanel').style.display = 'block';
                document.getElementById('orderBtn').style.display = 'block';
                document.getElementById('orderInfo').style.display = 'none';
            } else if (panel === 'profile') {
                document.getElementById('profilePanel').style.display = 'block';
                loadProfile();
            } else {
                document.getElementById('historyPanel').style.display = 'block';
                if (!currentUser?.isGuest) loadUserOrders();
            }
        };

        window.removeOneFromCart = removeOneFromCart;
        window.removeAllFromCart = removeAllFromCart;
    </script>
</body>
</html>
