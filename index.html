<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>üëë WHOPPER BAR ‚Ä¢ –ú–û–ë–ò–õ–¨–ù–´–ô –ó–ê–ö–ê–ó</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f8f2e6;
            min-height: 100vh;
            padding: 12px;
        }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        .auth-screen {
            background: linear-gradient(145deg, #4a3a2a, #2d1d0c);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
        }

        .auth-card {
            background: white;
            border-radius: 50px;
            padding: 40px 30px;
            width: 100%;
            max-width: 450px;
            border: 5px solid #fec233;
            text-align: center;
        }

        .auth-card h1 {
            color: #d62323;
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .auth-card h2 {
            color: #c53a1f;
            font-size: 1.5rem;
            margin-bottom: 25px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 3px solid #ba6b3c;
            border-radius: 60px;
            margin: 10px 0;
            text-align: center;
        }

        .phone-input {
            display: flex;
            align-items: center;
            border: 3px solid #ba6b3c;
            border-radius: 60px;
            margin: 10px 0;
            background: white;
        }

        .phone-prefix {
            padding: 15px;
            background: #d49b3b;
            border-radius: 60px 0 0 60px;
            font-weight: 700;
            color: white;
        }

        .phone-input input {
            flex: 1;
            border: none;
            padding: 15px;
            border-radius: 0 60px 60px 0;
            font-size: 1.1rem;
            outline: none;
        }

        .auth-btn {
            background: #d49b3b;
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 60px;
            width: 100%;
            cursor: pointer;
            font-weight: 700;
            margin: 10px 0;
            box-shadow: 0 4px 0 #7e491e;
        }

        .auth-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .guest-btn {
            background: none;
            border: 2px solid #ba6b3c;
            color: #ba6b3c;
            padding: 12px;
            border-radius: 60px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
        .main-app {
            display: none;
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: #d62323;
            color: white;
            padding: 15px;
            border-radius: 30px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 3px solid #fec233;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crowns {
            background: #fec233;
            color: #2d1d0c;
            padding: 8px 15px;
            border-radius: 40px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 5px 12px;
            border-radius: 30px;
            cursor: pointer;
        }

        .nav {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .nav-item {
            flex: 1;
            background: #5c3e1f;
            color: white;
            padding: 12px;
            border-radius: 30px;
            text-align: center;
            font-weight: 700;
            border: 2px solid #fec233;
            cursor: pointer;
        }

        .nav-item.active {
            background: #fec233;
            color: #2d1d0c;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            padding: 15px 8px;
            text-align: center;
            border: 2px solid #d8a76b;
            cursor: pointer;
            box-shadow: 0 4px 0 #b57c42;
            position: relative;
        }

        .product-card.crown-deal {
            border: 3px solid #fec233;
            background: #fff0d0;
        }

        .crown-price {
            position: absolute;
            top: -8px;
            right: -5px;
            background: #9c27b0;
            color: white;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .cart-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .cart-items {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin: 15px 0;
            max-height: 350px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #cbad86;
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-qty {
            background: #c1411b;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: 800;
        }

        .item-controls {
            display: flex;
            gap: 5px;
        }

        .item-btn {
            background: #c53a1f;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 700;
        }

        .item-btn.minus {
            background: #ff9800;
        }

        .cart-total {
            font-size: 1.8rem;
            font-weight: 800;
            color: #c53a1f;
            text-align: right;
            margin: 15px 0;
        }

        .order-btn {
            background: #d49b3b;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 30px;
            font-size: 1.3rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 0 #7e491e;
        }

        .order-info {
            background: white;
            border-radius: 30px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            border: 4px solid #4CAF50;
            display: none;
        }

        .order-number-big {
            font-size: 4rem;
            font-weight: 900;
            color: #c53a1f;
            background: #fff2d7;
            padding: 15px;
            border-radius: 30px;
            margin: 15px 0;
        }

        .order-status {
            font-size: 1.2rem;
            padding: 12px;
            border-radius: 30px;
            margin: 10px 0;
        }

        .status-waiting { background: #ff9800; color: white; }
        .status-ready { background: #4CAF50; color: white; }
        .status-done { background: #808080; color: white; }

        .history-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            border: 3px solid #fec233;
        }

        .history-item {
            background: #fff2d7;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #d8a76b;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 60px;
            font-weight: 600;
            z-index: 3000;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <h1>WHOPPER BAR</h1>
            <h2>üëë –ö–û–†–û–ù–ê</h2>
            <p style="margin-bottom: 20px;">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –≤—Ö–æ–¥–∞</p>
            
            <div class="phone-input">
                <span class="phone-prefix">+7</span>
                <input type="tel" id="phoneInput" placeholder="(999) 999-99-99" maxlength="10">
            </div>
            
            <button class="auth-btn" onclick="loginWithPhone()">
                <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
            </button>
            
            <button class="guest-btn" onclick="loginAsGuest()">
                <i class="fas fa-user"></i> –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å
            </button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="mainApp" class="main-app">
        <div class="header">
            <div class="logo">
                <i class="fas fa-crown"></i>
                <span>WHOPPER BAR</span>
            </div>
            <div class="user-info">
                <span class="crowns" id="userCrowns">
                    <i class="fas fa-crown"></i> 0
                </span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="showPanel('menu')">üçî –ú–ï–ù–Æ</div>
            <div class="nav-item" onclick="showPanel('cart')">üõí –ö–û–†–ó–ò–ù–ê</div>
            <div class="nav-item" onclick="showPanel('history')">üìã –ò–°–¢–û–†–ò–Ø</div>
        </div>

        <!-- –ú–µ–Ω—é -->
        <div id="menuPanel">
            <div class="products-grid" id="productsGrid"></div>
        </div>

        <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
        <div id="cartPanel" style="display: none;">
            <div class="cart-section">
                <div class="cart-items" id="cartItems"></div>
                <div class="cart-total" id="cartTotal">0 ‚ÇΩ</div>
                <button class="order-btn" onclick="placeOrder()">
                    <i class="fas fa-check-circle"></i> –ó–ê–ö–ê–ó–ê–¢–¨
                </button>

                <div class="order-info" id="orderInfo">
                    <h3>‚úÖ –ó–ê–ö–ê–ó –û–§–û–†–ú–õ–ï–ù</h3>
                    <div class="order-number-big" id="orderNumberDisplay">1234</div>
                    <div class="order-status status-waiting" id="orderStatus">
                        ‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è -->
        <div id="historyPanel" style="display: none;">
            <div class="history-section">
                <h3>üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
                <div class="orders-history" id="ordersHistory"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBlZ5ZtyTXgtXxSXJAx1jOxwhTrzlHRJmo",
            authDomain: "bk-cashier.firebaseapp.com",
            databaseURL: "https://bk-cashier-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bk-cashier",
            storageBucket: "bk-cashier.firebasestorage.app",
            messagingSenderId: "385000840969",
            appId: "1:385000840969:web:1ec8d09176b6551dc0fdd8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // –¢–µ –∂–µ —Ç–æ–≤–∞—Ä—ã, —á—Ç–æ –∏ –≤ –∫–∞—Å—Å–µ
        const products = [
            { id: 1, name: '–í–æ–ø–ø–µ—Ä', price: 199, crownPrice: 10 },
            { id: 2, name: '–ß–∏–∑–±—É—Ä–≥–µ—Ä', price: 89, crownPrice: 4 },
            { id: 3, name: '–î–≤–æ–π–Ω–æ–π –í–æ–ø–ø–µ—Ä', price: 329, crownPrice: 16 },
            { id: 4, name: '–¢—Ä–æ–π–Ω–æ–π –í–æ–ø–ø–µ—Ä', price: 449, crownPrice: 22 },
            { id: 5, name: '–í–æ–ø–ø–µ—Ä —Å —Å—ã—Ä–æ–º', price: 249, crownPrice: 12 },
            { id: 6, name: '–ë–µ–∫–æ–Ω –í–æ–ø–ø–µ—Ä', price: 299, crownPrice: 15 },
            { id: 7, name: '–°—Ç–µ–π–∫—Ö–∞—É—Å', price: 279, crownPrice: 14 },
            { id: 8, name: '–ë–∞—Ä–±–µ–∫—é –í–æ–ø–ø–µ—Ä', price: 289, crownPrice: 14 },
            { id: 9, name: '–ì–∞–º–±—É—Ä–≥–µ—Ä', price: 69, crownPrice: 3 },
            { id: 10, name: '–ë–∏–≥ –ö–∏–Ω–≥', price: 279, crownPrice: 14 },
            { id: 11, name: '–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π', price: 359, crownPrice: 18 },
            { id: 12, name: '–û—Å—Ç—Ä—ã–π –í–æ–ø–ø–µ—Ä', price: 269, crownPrice: 13 },
            { id: 13, name: '–ì—Ä–∏–ª—å –í–æ–ø–ø–µ—Ä', price: 289, crownPrice: 14 },
            { id: 14, name: '–ß–∏–∫–µ–Ω –ë—É—Ä–≥–µ—Ä', price: 129, crownPrice: 6 },
            { id: 15, name: '–§–∏—à –ë—É—Ä–≥–µ—Ä', price: 169, crownPrice: 8 },
            { id: 16, name: '–õ–æ–Ω–≥ –ß–∏–∫–µ–Ω', price: 219, crownPrice: 11 },
            { id: 17, name: '–õ–æ–Ω–≥ –ß–∏–∫–µ–Ω BBQ', price: 239, crownPrice: 12 },
            { id: 18, name: '–õ–æ–Ω–≥ –ß–∏–∫–µ–Ω –†–∞–Ω—á', price: 239, crownPrice: 12 },
            { id: 19, name: '–°—Ç—Ä–∏–ø—Å—ã 3—à—Ç', price: 149, crownPrice: 7 },
            { id: 20, name: '–°—Ç—Ä–∏–ø—Å—ã 6—à—Ç', price: 269, crownPrice: 13 }
        ];

        let currentUser = null;
        let cart = [];
        let userCrowns = 0;
        let userOrders = [];

        // ========== –ü–†–û–í–ï–†–ö–ê –°–û–•–†–ê–ù–Å–ù–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
        (function checkSavedUser() {
            const saved = localStorage.getItem('whopperUser');
            if (saved) {
                try {
                    const userData = JSON.parse(saved);
                    if (userData.phone) {
                        loginWithPhone(userData.phone, true);
                    }
                } catch (e) {
                    console.log('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            }
        })();

        // ========== –í–•–û–î –ü–û –¢–ï–õ–ï–§–û–ù–£ ==========
        window.loginWithPhone = (savedPhone, isAuto = false) => {
            let phone;
            if (isAuto) {
                phone = savedPhone;
            } else {
                phone = document.getElementById('phoneInput').value.trim();
                if (!phone || phone.length < 10) {
                    showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é');
                    return;
                }
                phone = '+7' + phone;
            }

            db.ref('users').orderByChild('phone').equalTo(phone).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    snapshot.forEach((child) => {
                        currentUser = child.val();
                        currentUser.id = child.key;
                        userCrowns = currentUser.crowns || 0;
                    });
                    showToast(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${currentUser.name || '–ì–æ—Å—Ç—å'}!`);
                } else {
                    // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    currentUser = {
                        id: userId,
                        phone: phone,
                        name: '–ì–æ—Å—Ç—å',
                        crowns: 0,
                        registeredAt: Date.now()
                    };
                    db.ref('users/' + userId).set(currentUser);
                    userCrowns = 0;
                    showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('whopperUser', JSON.stringify({
                    phone: phone,
                    name: currentUser.name
                }));

                enterApp();
            });
        };

        // ========== –í–•–û–î –ö–ê–ö –ì–û–°–¢–¨ ==========
        window.loginAsGuest = () => {
            const guestId = 'guest_' + Date.now();
            currentUser = {
                id: guestId,
                name: '–ì–æ—Å—Ç—å',
                isGuest: true,
                crowns: 0
            };
            
            localStorage.removeItem('whopperUser');
            showToast('–í—Ö–æ–¥ –∫–∞–∫ –≥–æ—Å—Ç—å');
            enterApp();
        };

        function enterApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userCrowns').innerHTML = `<i class="fas fa-crown"></i> ${userCrowns}`;
            
            renderProducts();
            updateCart();
            loadUserOrders();
            listenToUserCrowns();
        }

        // ========== –í–´–•–û–î ==========
        window.logout = () => {
            currentUser = null;
            cart = [];
            userOrders = [];
            localStorage.removeItem('whopperUser');
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('phoneInput').value = '';
        };

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==========
        function loadUserOrders() {
            if (!currentUser || currentUser.isGuest) return;
            
            db.ref('orders').orderByChild('userId').equalTo(currentUser.id).on('value', (snapshot) => {
                const orders = snapshot.val();
                userOrders = [];
                
                for (let num in orders) {
                    userOrders.push({
                        number: num,
                        ...orders[num]
                    });
                }
                
                userOrders.sort((a, b) => b.createdAt - a.createdAt);
                displayHistory();
            });
        }

        function listenToUserCrowns() {
            if (!currentUser || currentUser.isGuest) return;
            
            db.ref('users/' + currentUser.id + '/crowns').on('value', (snapshot) => {
                userCrowns = snapshot.val() || 0;
                document.getElementById('userCrowns').innerHTML = `<i class="fas fa-crown"></i> ${userCrowns}`;
                renderProducts();
            });
        }

        // ========== –†–ï–ù–î–ï–† –¢–û–í–ê–†–û–í ==========
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            products.forEach(p => {
                const canUseCrowns = !currentUser?.isGuest && userCrowns >= p.crownPrice;
                const card = document.createElement('div');
                card.className = `product-card ${canUseCrowns ? 'crown-deal' : ''}`;
                
                card.innerHTML = `
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${p.price} ‚ÇΩ</div>
                    ${!currentUser?.isGuest ? `<div class="crown-price"><i class="fas fa-crown"></i> ${p.crownPrice}</div>` : ''}
                `;
                
                card.onclick = () => addToCart(p, canUseCrowns);
                grid.appendChild(card);
            });
        }

        // ========== –†–ê–ë–û–¢–ê –° –ö–û–†–ó–ò–ù–û–ô ==========
        function addToCart(product, useCrowns = false) {
            const existing = cart.find(i => i.id === product.id);
            
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ 
                    ...product, 
                    quantity: 1,
                    useCrowns: useCrowns,
                    finalPrice: useCrowns ? 1 : product.price,
                    crownsSpent: useCrowns ? product.crownPrice : 0
                });
            }
            
            updateCart();
            showToast('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
        }

        function removeOneFromCart(id) {
            const index = cart.findIndex(i => i.id === id);
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        }

        function removeAllFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            updateCart();
        }

        function updateCart() {
            const container = document.getElementById('cartItems');
            const totalSpan = document.getElementById('cartTotal');

            if (cart.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
                totalSpan.innerText = '0 ‚ÇΩ';
                return;
            }

            let html = '';
            let total = 0;
            let totalCrownsSpent = 0;
            
            cart.forEach(item => {
                const itemTotal = (item.useCrowns ? 1 : item.price) * item.quantity;
                total += itemTotal;
                if (item.useCrowns) totalCrownsSpent += item.crownsSpent * item.quantity;
                
                html += `
                    <div class="cart-item">
                        <div class="item-info">
                            <span class="item-qty">${item.quantity}</span>
                            <span>${item.name}</span>
                            ${item.useCrowns ? '<span style="color:#9c27b0;"><i class="fas fa-crown"></i></span>' : ''}
                        </div>
                        <div class="item-controls">
                            <span>${itemTotal} ‚ÇΩ</span>
                            <button class="item-btn minus" onclick="removeOneFromCart(${item.id})">‚àí</button>
                            <button class="item-btn" onclick="removeAllFromCart(${item.id})">‚úï</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            totalSpan.innerText = total + ' ‚ÇΩ';
        }

        // ========== –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ==========
        function placeOrder() {
            if (cart.length === 0) {
                showToast('‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }

            const totalCrownsSpent = cart.reduce((acc, i) => acc + (i.useCrowns ? i.crownsSpent * i.quantity : 0), 0);
            
            if (!currentUser.isGuest && totalCrownsSpent > userCrowns) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ—Ä–æ–Ω');
                return;
            }

            const orderNum = Math.floor(1000 + Math.random() * 9000);
            const total = cart.reduce((acc, i) => acc + (i.useCrowns ? 1 : i.price) * i.quantity, 0);
            const crownEarned = Math.floor(total / 100);

            const orderData = {
                userId: currentUser.id,
                userName: currentUser.name || '–ì–æ—Å—Ç—å',
                items: cart,
                total: total,
                crownsSpent: totalCrownsSpent,
                crownsEarned: crownEarned,
                status: 'waiting',
                createdAt: Date.now()
            };

            db.ref('orders/' + orderNum).set(orderData).then(() => {
                if (!currentUser.isGuest && totalCrownsSpent > 0) {
                    const newCrowns = userCrowns - totalCrownsSpent;
                    db.ref('users/' + currentUser.id + '/crowns').set(newCrowns);
                }
                
                document.getElementById('orderInfo').style.display = 'block';
                document.getElementById('orderNumberDisplay').innerText = orderNum;
                
                listenToOrder(orderNum);
                
                cart = [];
                updateCart();
                showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
            });
        }

        function listenToOrder(orderNum) {
            db.ref('orders/' + orderNum).on('value', (snapshot) => {
                const order = snapshot.val();
                if (order) {
                    const statusDiv = document.getElementById('orderStatus');
                    
                    if (order.status === 'ready') {
                        statusDiv.innerHTML = '‚úÖ –ó–ê–ö–ê–ó –ì–û–¢–û–í!';
                        statusDiv.className = 'order-status status-ready';
                        showToast('‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤!');
                        if (navigator.vibrate) navigator.vibrate(200);
                    } else if (order.status === 'done') {
                        statusDiv.innerHTML = 'üõí –ó–ê–ö–ê–ó –í–´–î–ê–ù';
                        statusDiv.className = 'order-status status-done';
                        
                        if (!currentUser.isGuest && order.crownsEarned) {
                            const newCrowns = userCrowns + order.crownsEarned;
                            db.ref('users/' + currentUser.id + '/crowns').set(newCrowns);
                        }
                    }
                }
            });
        }

        function displayHistory() {
            const historyDiv = document.getElementById('ordersHistory');
            
            if (userOrders.length === 0) {
                historyDiv.innerHTML = '<div style="text-align:center; padding:20px;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                return;
            }

            let html = '';
            userOrders.forEach(order => {
                let statusText = '';
                if (order.status === 'waiting') statusText = '‚è≥ –ì–æ—Ç–æ–≤–∏—Ç—Å—è';
                else if (order.status === 'ready') statusText = '‚úÖ –ì–æ—Ç–æ–≤';
                else statusText = 'üõí –í—ã–¥–∞–Ω';

                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-number">–ó–∞–∫–∞–∑ #${order.number}</span>
                            <span><i class="fas fa-crown"></i> +${order.crownsEarned || 0}</span>
                        </div>
                        <div>${order.items.map(i => `${i.name} x${i.quantity}`).join(' ‚Ä¢ ')}</div>
                        <div style="margin-top:5px;">–°—É–º–º–∞: ${order.total} ‚ÇΩ ‚Ä¢ ${statusText}</div>
                    </div>
                `;
            });
            
            historyDiv.innerHTML = html;
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerHTML = text;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
        }

        window.showPanel = (panel) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('menuPanel').style.display = 'none';
            document.getElementById('cartPanel').style.display = 'none';
            document.getElementById('historyPanel').style.display = 'none';

            if (panel === 'menu') {
                document.getElementById('menuPanel').style.display = 'block';
            } else if (panel === 'cart') {
                document.getElementById('cartPanel').style.display = 'block';
            } else {
                document.getElementById('historyPanel').style.display = 'block';
                if (!currentUser?.isGuest) loadUserOrders();
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.removeOneFromCart = removeOneFromCart;
        window.removeAllFromCart = removeAllFromCart;
    </script>
</body>
</html>
